<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" type="text/css" href="./editor/assets/editor.css">

    <title>Icon project for Echat</title>
    <style id="font-style">
        @font-face {
            font-family: echat;
            src: url('./fonts/echat.eot');
            /* IE9*/
            src: url('./fonts/echat.woff2') format('woff2'),
                url('./fonts/echat.woff') format('woff'),
                /* chrome, firefox */
                url('./fonts/echat.ttf') format('truetype'),
                /* chrome, firefox, opera, Safari, Android, iOS 4.2+*/
                url('./fonts/echat.svg#echat') format('svg');
            /* iOS 4.1- */
        }
    </style>
    <style id="cc-style">
        /**图标样式控制*/
        .font-icon {
            color: #39ca39;
        }
    </style>
    <script src="./editor/assets/seajs.js"></script>
    <script src="./editor/assets/magix.js"></script>
    <script src="./js/ui.js"></script>
    <link rel="stylesheet" href="./css/ui.css" type="text/css" />
</head>

<body>
    <div class="nav-header">
        <div class="project-opts">
            <a id="icon-up" href="javascript:;">上传图标<span class="upload-ico">₪</span>
                <input type="file" id="uploadinput" multiple="" accept="image/svg+xml" class="upload-input" />
            </a>
            <span>图标颜色：<input type="color" id="icon_color" value="#39ca39" /></span>
            <span>图标大小：<input type="number" id="icon_size" value="42" style="width: 34px;" /></span>
        </div>
        <div class="ext-opts">
            <div class="opt-icons" id="ext-icons"></div>
            <div><button id="upload-btn">上传</button><button id="upload-cancel">取消</button></div>
        </div>
    </div>
    <div id='icons'>

    </div>
    <div class="icon-pt">
        <div><span class="font-icon"></span></div>
        <div class="icon-info">
            <span class="icon-name"></span>
            <div><span class="icon-code"></span>&nbsp;&nbsp;<span class="icon-html"></span></div>
            <div class="icon-edit-btns"><span class="icon-edit">编辑</span></div>
        </div>
    </div>

    <div id="root"></div>
    <script>
        // seajs 的简单配置
        seajs.config({
            base: "./editor",
            alias: {
                "$": "assets/jquery.js",
                "jquery": "assets/jquery.js",
                "magix": "assets/magix.js",
                "pat": "assets/magix/pat",
                "tmpl": "assets/magix/tmpl",

                //"exts": "assets/magix/exts.js",
            }
        });

        define('buildIcons', [], function (require, exports, module) {

            var iconTpl = document.getElementsByClassName('icon-pt')[0];
            module.exports = function cloneIcon(res) {
                var { code, name, id } = res,
                    icon = iconTpl.cloneNode(true);

                icon.querySelector('.font-icon').innerHTML = String.fromCharCode(`0x${code}`);
                icon.querySelector('.icon-name').innerHTML = name;
                icon.querySelector('.icon-code').innerHTML = `0x${code}`;
                icon.querySelector('.icon-html').innerText = `&#x${code};`;

                /** 编辑 */
                var editBtn = icon.querySelector('.icon-edit');
                editBtn.setAttribute('fn', id);
                editBtn.addEventListener('click', function (e) {

                    var fn = this.getAttribute('fn');

                    $.ajax({ method: 'GET', url: `/svg/get`, data: { fn } }).then((xmlString) => {
                        xmlString = xmlString.replace(/xmlns\=("|').+svg("|')/, '');

                        var viewWidth = 1024,
                            viewHeight = 1024,
                            viewDims = new DOMParser().parseFromString(xmlString, 'text/xml').firstElementChild.getAttribute('viewBox').split(/\s|,/);
                        try {

                            if (viewDims.length == 1) {
                                viewWidth = viewDims[0];
                                viewHeight = viewDims[0];
                            } else {
                                viewWidth = viewDims[2];
                                viewHeight = viewDims[3];
                            }
                        } catch (e) {
                            console.warn(e);
                        }

                        require('assets/magix/helper').showDialog("assets/magix/edit_view", {
                            viewOptions: {
                                unicode: parseInt(code, 16),
                                name,
                                id,
                                viewWidth,
                                viewHeight,
                                isProject: true,
                                show_svg: xmlString
                            },
                            width: 910,
                            height: 685,
                            dockClass: "edit-dialog"
                        })
                    });

                });

                return icon;
            }

            function GetDetailSvgProps(svgDom) {
                var viewBox = svgDom.getAttribute('viewBox');

            }

        })

        define("app/index", ["magix", "assets/magix/helper", 'tmpl'], function (i, a, e) {
            var v = i("magix")
                , t = v.Router
                , n = i("assets/magix/helper");
            e.exports = v.View.extend({
                tmpl: '<div class="block-switch-loading" data-spm="1998910417"></div></div>',
                ctor: function () {
                    //this.observe(null, !0)
                },
                render: function () {

                }
            })
        });



        seajs.use(['magix', "jquery", "pat", "buildIcons", "tmpl"], function (Magix, jquery, pat, buildIcons) {

            Magix.boot({
                defaultPath: '/index',
                defaultView: 'app/index',
                rootId: 'root',
                error: (e) => {
                    setTimeout(() => {
                        throw e;
                    }, 0);
                },
                exts: ["assets/magix/exts"]
            });

            //加载图标
            $.ajax({
                url: '/svg/icons',
            }).then(function (res) {

                var frame = document.createDocumentFragment();
                res.sort((a, b) => {//将图标以code大小顺序排序一下
                    return a.code.localeCompare(b.code) > 0 ? 1 : -1
                });

                for (var i = 0; i < res.length; i++) {
                    frame.appendChild(buildIcons(res[i]));
                }
                document.getElementById('icons').appendChild(frame)
            });
        });

    </script>
</body>

</html>